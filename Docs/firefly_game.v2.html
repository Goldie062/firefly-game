<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Firefly Hunter Carnival</title>
<style>
  :root {
    /* 你可以在這裡改顏色（例如 GOOD JOB 太亮就改這些） */
    --night-top:    #ffd2d6;  /* 遊樂園粉色天空 */
    --night-bottom: #5c66c9;
    --marquee-bg:   rgba(255, 255, 255, 0.20);
    --text-main:    #ffffff;
    --text-goodjob: #ffe9b2;  /* GOOD JOB 主色 */
    --text-goodjob-glow: #ffb347;
  }

  html, body {
    margin:0; padding:0;
    width:100%; height:100%;
    background: #000;
    overflow:hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    -webkit-user-select:none;
    user-select:none;
    touch-action:none;
  }
  .wrap {
    width:100vw; height:100vh;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(circle at top, #ffe4f2 0, #1a123b 70%);
  }
  canvas {
    width:100vw;
    height:100vh;
    max-width:100vw;
    max-height:100vh;
    object-fit:contain;
    border-radius:18px;
    box-shadow:0 8px 30px rgba(0,0,0,0.55);
    background:#000;
  }
  video { display:none; }

  .overlayTip{
    position:fixed;
    left:50%; top:10px;
    transform:translateX(-50%);
    padding:6px 12px;
    border-radius:999px;
    background:rgba(0,0,0,0.5);
    color:#fff;
    font-size:13px;
    z-index:10;
  }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="640" height="480"></canvas>
</div>
<div id="tip" class="overlayTip">點一下畫面，允許相機與聲音後開始玩唷！</div>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* ========= 基本設定 ========= */
const GAME_W = 640, GAME_H = 480;
const NUM_FIREFLIES = 5;
const GAME_DURATION = 60;  // 秒

// 手的圖片大小（熊掌）
const HAND_TARGET_W = 260;

// 右上角小熊方匡（只在遊戲中顯示）
const AVATAR_BOX_W  = 150;
const AVATAR_BOX_H  = 150;
const AVATAR_MARGIN = 12;
const FORBID_PADDING = 10;

// 糖果門檻（60 秒）
const CANDY_1_MAX = 10;    // 0~10  -> 1 顆
const CANDY_2_MAX = 20;    // 11~20 -> 2 顆
const CANDY_3_MIN = 21;    // 21+   -> 3 顆

// 檔案名稱（跟 index.html 放一起）
const ASSETS = {
  background : "background.jpg",
  avatar     : "avatar.jpg",
  hand       : "hand.png",
  candy      : "candy.png",
  musicMenu  : "menu_bg.mp3",
  musicGame  : "game_bg.mp3",
  sfxClick   : "button_click.wav",
  sfxCatch   : "catch_sound.wav"
};

// 顏色
const COLORS = {
  nightTop    : getComputedStyle(document.documentElement).getPropertyValue('--night-top'),
  nightBottom : getComputedStyle(document.documentElement).getPropertyValue('--night-bottom'),
  marqueeBg   : getComputedStyle(document.documentElement).getPropertyValue('--marquee-bg'),
  white       : "#ffffff",
  yellow      : "#fff9b0",
  candyPink   : "#ff96d3",
  green       : "#59ff94",
  red         : "#ff6161",
  hudTime     : "#ffffff",
  hudScore    : "#ffe36a",
  goodjobMain : getComputedStyle(document.documentElement).getPropertyValue('--text-goodjob'),
  goodjobGlow : getComputedStyle(document.documentElement).getPropertyValue('--text-goodjob-glow')
};

/* ========= 狀態 ========= */
const STATE_MENU = 0;
const STATE_GAME = 1;
const STATE_OVER = 2;
let state = STATE_MENU;
let score = 0;
let gameStartTime = 0;

/* ========= 畫布與資源 ========= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const img = { bg:null, avatar:null, hand:null, candy:null };
const audio = { music:new Audio(), click:new Audio(), catch:new Audio() };
audio.music.loop = true;

let audioUnlocked = false;

/* ========= 手部偵測 ========= */
let handX = null, handY = null, isPinching = false;
const videoEl = document.createElement("video");
videoEl.playsInline = true;
document.body.appendChild(videoEl);

const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5,
  selfieMode: true
});
hands.onResults((results) => {
  const lm = results.multiHandLandmarks?.[0];
  if (!lm) { handX = handY = null; isPinching=false; return; }

  // 捲指判斷（index/middle/ring/pinky tip 與 pip 距離）
  const tips = [8,12,16,20];
  const pips = [6,10,14,18];
  let curled = 0;
  for (let i=0;i<tips.length;i++){
    const t = lm[tips[i]], p = lm[pips[i]];
    const d = Math.hypot(t.x - p.x, t.y - p.y);
    if (d < 0.1) curled++;
  }
  isPinching = curled >= 2;

  const idx = lm[8];
  handX = Math.floor(idx.x * GAME_W);
  handY = Math.floor(idx.y * GAME_H);
});

/* ========= Firefly 類別 ========= */
class Firefly {
  constructor(){
    this.r = 20;
    this.x = randInt(this.r+30, GAME_W - this.r - 30);
    this.y = randInt(this.r+30, GAME_H - this.r - 30);
    this.initialY = this.y;
    this.dx = rand(-2,2) * 1.5;
    this.dy = rand(-1.2,1.2) * 1.2;
  }
  avoidSpawn(forbid){
    if (!forbid) return;
    const [fx1,fy1,fx2,fy2] = forbid;
    if (this.x >= fx1 && this.x <= fx2 && this.y >= fy1 && this.y <= fy2){
      this.x = clamp(fx1 - this.r - 10, this.r+30, GAME_W - this.r - 30);
      this.y = clamp(this.y, this.r+30, GAME_H - this.r - 30);
      this.initialY = this.y;
    }
  }
  move(forbid){
    this.x += this.dx;
    this.initialY += this.dy * 0.25;
    this.y = Math.floor(this.initialY + Math.sin(perf()*0.002*2 + this.x*0.05) * 10);

    if (this.x < this.r+30 || this.x > GAME_W - this.r - 30){
      this.dx *= -1;
      this.x = clamp(this.x, this.r+30, GAME_W - this.r - 30);
    }
    if (this.y < this.r+30 || this.y > GAME_H - this.r - 30){
      this.dy *= -1;
      this.y = Math.floor(clamp(this.y, this.r+30, GAME_H - this.r - 30));
      this.initialY = this.y;
    }

    if (forbid){
      const [fx1,fy1,fx2,fy2] = forbid;
      const me = [this.x-this.r, this.y-this.r, this.x+this.r, this.y+this.r];
      if (rectsOverlap(me, forbid)){
        const cx=this.x, cy=this.y;
        const dL = Math.abs(cx-fx1), dR = Math.abs(fx2-cx);
        const dT = Math.abs(cy-fy1), dB = Math.abs(fy2-cy);
        const m = Math.min(dL,dR,dT,dB);
        if (m===dL){ this.x = fx1 - this.r -1; this.dx = -Math.abs(this.dx);}
        else if(m===dR){ this.x = fx2 + this.r +1; this.dx =  Math.abs(this.dx);}
        else if(m===dT){ this.y = fy1 - this.r -1; this.initialY=this.y; this.dy=-Math.abs(this.dy);}
        else { this.y = fy2 + this.r +1; this.initialY=this.y; this.dy= Math.abs(this.dy);}
      }
    }
  }
  draw(ctx){
    const t = perf()*0.008;
    const blink = (Math.sin(t) + 1)*0.5;

    // 光圈
    circle(ctx, this.x + this.r*0.4, this.y + this.r*1.3, this.r*1.2, "rgba(255,255,200,0.35)");

    const hr = this.r*0.7, hx = this.x - this.r*0.8, hy = this.y - this.r*0.2;
    circle(ctx, hx, hy, hr, "rgb(255,196,140)");

    ellipse(ctx, this.x, this.y + this.r*0.1, this.r*0.8, this.r*0.9, 0, "rgb(255,214,160)");

    const g = Math.floor(200 + blink*55);
    ellipse(ctx, this.x, this.y + this.r*0.8, this.r*0.7, this.r*0.6, 0, `rgb(255,${g},130)`);

    ctx.save();
    ctx.globalAlpha = 0.6;
    ellipse(ctx, hx + hr*0.8, hy - hr*1.2, this.r*1.2, this.r*0.7, -30*Math.PI/180, "rgba(255,255,255,0.8)");
    ellipse(ctx, hx + hr*0.8, hy + hr*0.7, this.r*1.2, this.r*0.7,  30*Math.PI/180, "rgba(255,255,255,0.8)");
    ctx.restore();

    circle(ctx, hx - hr*0.3, hy - hr*0.3, 3, "#000");
    circle(ctx, hx + hr*0.3, hy - hr*0.3, 3, "#000");
    arc(ctx, hx, hy + hr*0.3, hr*0.4, 0, Math.PI, "#000", 2);
  }
  hit(x,y){
    const cx = this.x + this.r*0.9;
    const cy = this.y + this.r*0.8;
    return Math.hypot(cx-x, cy-y) < this.r*1.5;
  }
}
let fireflies = [];

/* ========= 場景繪製 ========= */
function drawGradientBG(){
  const g = ctx.createLinearGradient(0,0,0,GAME_H);
  g.addColorStop(0, COLORS.nightTop);
  g.addColorStop(1, COLORS.nightBottom);
  ctx.fillStyle = g;
  ctx.fillRect(0,0,GAME_W,GAME_H);
}
function addStarfield(n=120){
  for(let i=0;i<n;i++){
    const x=randInt(10,GAME_W-10), y=randInt(20,Math.floor(GAME_H*0.6));
    const r=randInt(1,3);
    ctx.fillStyle = `rgba(255,255,255,${rand(0.3,0.9)})`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}
function addBokeh(n=12){
  ctx.save();
  ctx.globalAlpha=0.3;
  for(let i=0;i<n;i++){
    const x=randInt(50,GAME_W-50), y=randInt(40,Math.floor(GAME_H*0.6));
    const r=randInt(20,60);
    ctx.fillStyle = `rgba(${randInt(250,255)},${randInt(180,230)},${randInt(210,255)},1)`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}
function drawMarquee(){
  const pad=12;
  ctx.save();
  ctx.fillStyle = COLORS.marqueeBg;
  roundRect(ctx,pad,pad,GAME_W-pad*2,GAME_H-pad*2,16,true,false);
  ctx.restore();

  ctx.strokeStyle="rgba(255,255,255,0.85)";
  ctx.lineWidth=3;
  roundRect(ctx,pad,pad,GAME_W-pad*2,GAME_H-pad*2,16,false,true);

  const step=40;
  const t = Date.now()/1000;
  const phase = Math.floor(t*5) % step;
  for(let x=pad+14;x<=GAME_W-pad-14;x+=step){
    const c=((Math.floor(x/step)+phase)%2===0)?"#fff9b0":"#ffc3e0";
    dot(ctx,x,pad+8,5,c); dot(ctx,x,GAME_H-pad-8,5,c);
  }
  for(let y=pad+14;y<=GAME_H-pad-14;y+=step){
    const c=((Math.floor(y/step)+phase)%2===0)?"#fff9b0":"#ffc3e0";
    dot(ctx,pad+8,y,5,c); dot(ctx,GAME_W-pad-8,y,5,c);
  }
}

function neonText(text,y,scale,main,glow){
  ctx.save();
  const size = 26*scale;
  ctx.font = `900 ${size}px "Segoe UI", system-ui`;
  const w = ctx.measureText(text).width;
  const x = (GAME_W - w)/2;

  ctx.lineWidth=scale*6;
  ctx.strokeStyle="rgba(0,0,0,0.8)";
  ctx.strokeText(text,x+2,y+2);

  [8,4,2].forEach(k=>{
    ctx.lineWidth=scale*(k+2);
    ctx.strokeStyle=glow;
    ctx.strokeText(text,x,y);
  });

  ctx.fillStyle=main;
  ctx.lineWidth=scale*3;
  ctx.strokeStyle=main;
  ctx.strokeText(text,x,y);
  ctx.fillText(text,x,y);
  ctx.restore();
}

function pill(text,y,width,height){
  const x=(GAME_W-width)/2;
  ctx.save();
  ctx.globalAlpha=0.9;
  ctx.fillStyle="rgba(255,255,255,0.85)";
  roundRect(ctx,x,y-height/2,width,height,999,true,false);
  ctx.restore();
  ctx.strokeStyle="rgba(255,168,196,0.9)";
  ctx.lineWidth=2;
  roundRect(ctx,x,y-height/2,width,height,999,false,true);

  ctx.font="bold 18px system-ui";
  const tw=ctx.measureText(text).width;
  ctx.fillStyle="#ff5e8e";
  ctx.fillText(text,(GAME_W-tw)/2,y+6);
}

function drawHUD(remain){
  ctx.font="bold 20px system-ui";
  const t = `TIME: ${String(Math.floor(remain)).padStart(2,"0")}s`;
  const s = `SCORE: ${score}`;
  ctx.lineWidth=6; ctx.strokeStyle="#000";
  ctx.strokeText(t,12,30); ctx.strokeText(s,12,60);
  ctx.fillStyle=COLORS.hudTime; ctx.fillText(t,12,30);
  ctx.fillStyle=COLORS.hudScore; ctx.fillText(s,12,60);
}

function drawAvatarBox(){
  const x1 = GAME_W - AVATAR_MARGIN - AVATAR_BOX_W;
  const y1 = AVATAR_MARGIN;
  const x2 = GAME_W - AVATAR_MARGIN;
  const y2 = AVATAR_MARGIN + AVATAR_BOX_H;

  ctx.save();
  ctx.globalAlpha=0.7;
  ctx.fillStyle="rgba(255,255,255,0.85)";
  roundRect(ctx,x1,y1,AVATAR_BOX_W,AVATAR_BOX_H,18,true,false);
  ctx.restore();
  ctx.strokeStyle="#ff99c8";
  ctx.lineWidth=3;
  roundRect(ctx,x1,y1,AVATAR_BOX_W,AVATAR_BOX_H,18,false,true);

  if (img.avatar){
    const maxW=AVATAR_BOX_W-14,maxH=AVATAR_BOX_H-14;
    const scale = Math.min(maxW/img.avatar.width, maxH/img.avatar.height);
    const w = img.avatar.width*scale, h = img.avatar.height*scale;
    const ox = x1 + (AVATAR_BOX_W-w)/2;
    const oy = y1 + (AVATAR_BOX_H-h)/2;
    ctx.drawImage(img.avatar,ox,oy,w,h);
  }

  return [x1-FORBID_PADDING,y1-FORBID_PADDING,x2+FORBID_PADDING,y2+FORBID_PADDING];
}

/* ========= Candy ========= */
function drawCandy(cx,cy,lit){
  if (!img.candy){
    ctx.fillStyle = lit ? COLORS.candyPink : "rgba(255,150,211,0.35)";
    circle(ctx,cx,cy,24,ctx.fillStyle); return;
  }
  const targetW=80;
  const scale = targetW/img.candy.width;
  const w = targetW, h = img.candy.height*scale;
  ctx.save();
  if (!lit) ctx.globalAlpha=0.35;
  ctx.drawImage(img.candy,cx-w/2,cy-h/2,w,h);
  ctx.restore();
}

/* ========= 各場景 ========= */
function drawMenu(){
  drawGradientBG(); addStarfield(120); addBokeh(12); drawMarquee();
  neonText("FIREFLY CARNIVAL",130,1.9,"#ffffff","#ff96d3");
  neonText("Curl your fingers to catch the fireflies!",195,0.8,"#fff","#ff96d3");
  pill("Press [S] to START GAME", 300, 420, 52);
  pill("Press [Q] to QUIT",       360, 320, 48);
}

function drawGame(){
  // 背景圖
  if (img.bg) ctx.drawImage(img.bg,0,0,GAME_W,GAME_H);
  else { drawGradientBG(); addStarfield(80); }

  const forbid = drawAvatarBox();

  if (img.hand && handX !== null && handY !== null){
    const scale = HAND_TARGET_W / img.hand.width;
    const w = HAND_TARGET_W;
    const h = img.hand.height * scale;
    ctx.drawImage(img.hand, handX-w/2, handY-h/2, w, h);
  }

  const now = performance.now()/1000;
  const remain = Math.max(0, GAME_DURATION - (now - gameStartTime));

  const next=[];
  for (const f of fireflies){
    f.move(forbid);
    f.draw(ctx);
    let caught=false;
    if (isPinching && handX!==null && handY!==null && f.hit(handX,handY)){
      score++;
      playSfx(audio.catch);
      ctx.font="bold 14px system-ui";
      ctx.lineWidth=3; ctx.strokeStyle="#000";
      ctx.strokeText("CAUGHT!", f.x-20, f.y-28);
      ctx.fillStyle="#ffe36a";
      ctx.fillText("CAUGHT!", f.x-20, f.y-28);
      caught=true;
    }
    if (!caught) next.push(f);
  }
  while (next.length < NUM_FIREFLIES){
    const nf = new Firefly(); nf.avoidSpawn(forbid); next.push(nf);
  }
  fireflies = next;

  drawHUD(remain);
  if (remain <= 0){
    stopMusic();
    state = STATE_OVER;
  }
}

function drawOver(){
  drawGradientBG(); addStarfield(120); addBokeh(10); drawMarquee();

  neonText("GOOD JOB!",110,1.4,COLORS.goodjobMain,COLORS.goodjobGlow);
  neonText(`YOU CAUGHT ${score} FIREFLIES`,170,1.2,"#ffffff","#ff96d3");

  let candies=1,msg="Nice start! Try again!";
  if (score >= CANDY_3_MIN){ candies=3; msg="Excellent coordination!"; }
  else if (score > CANDY_1_MAX && score <= CANDY_2_MAX){ candies=2; msg="Great effort, keep going!"; }

  neonText(msg,220,0.8,"#ffffff","#ff96d3");

  const centers = [[GAME_W/2-120,310],[GAME_W/2,310],[GAME_W/2+120,310]];
  for (let i=0;i<3;i++) drawCandy(centers[i][0], centers[i][1], i<candies);

  pill("Press [R] to RESTART", GAME_H-96, 360, 46);
  pill("Press [Q] to HOME",    GAME_H-48, 340, 46);
}

/* ========= HUD / 音樂 / 遊戲控制 ========= */
function resetGame(){
  score = 0;
  gameStartTime = performance.now()/1000;
  fireflies = Array.from({length:NUM_FIREFLIES},()=>new Firefly());
}

function startMusicFor(st){
  if (!audioUnlocked) return;
  audio.music.pause();
  audio.music.src = (st===STATE_GAME)? ASSETS.musicGame : ASSETS.musicMenu;
  audio.music.currentTime=0;
  audio.music.play().catch(()=>{});
}
function stopMusic(){ try{ audio.music.pause(); }catch(e){} }
function playSfx(a){ try{ a.currentTime=0; a.play().catch(()=>{}); }catch(e){} }

/* ========= 鍵盤 ========= */
window.addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  if (k==="s"){
    if (state===STATE_MENU){
      playSfx(audio.click);
      state=STATE_GAME;
      resetGame();
      startMusicFor(STATE_GAME);
    }
  }else if (k==="r"){
    if (state===STATE_OVER){
      playSfx(audio.click);
      state=STATE_MENU;
      startMusicFor(STATE_MENU);
    }
  }else if (k==="q"){
    if (state===STATE_OVER){
      playSfx(audio.click);
      state=STATE_MENU;      // 回首頁
      startMusicFor(STATE_MENU);
    }else if(state===STATE_MENU){
      // 主畫面 Q：保持原地或導回其他頁面（需要的話你可在這裡做 redirect）
    }
  }
});

/* ========= 繪圖工具 ========= */
function circle(ctx,x,y,r,color){
  ctx.fillStyle=color;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
}
function ellipse(ctx,cx,cy,rx,ry,rot,color){
  ctx.save();
  ctx.translate(cx,cy); ctx.rotate(rot); ctx.scale(rx,ry);
  ctx.beginPath(); ctx.arc(0,0,1,0,Math.PI*2);
  ctx.fillStyle=color; ctx.fill();
  ctx.restore();
}
function arc(ctx,cx,cy,r,s,e,color,width){
  ctx.beginPath(); ctx.arc(cx,cy,r,s,e);
  ctx.lineWidth=width; ctx.strokeStyle=color; ctx.stroke();
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if (w < 2*r) r=w/2;
  if (h < 2*r) r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if (fill){ ctx.fill(); }
  if (stroke){ ctx.stroke(); }
}
function dot(ctx,x,y,r,c){ circle(ctx,x,y,r,c); }

function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rand(a,b){ return a + Math.random()*(b-a); }
function randInt(a,b){ return Math.floor(rand(a,b)); }
function rectsOverlap(a,b){
  return !(a[2]<=b[0] || a[0]>=b[2] || a[3]<=b[1] || a[1]>=b[3]);
}
function perf(){ return performance.now(); }

/* ========= 載入資源 ========= */
function loadImage(src){
  return new Promise((res,rej)=>{
    const i=new Image();
    i.onload=()=>res(i); i.onerror=rej; i.src=src;
  });
}
async function loadAssets(){
  try{ img.bg = await loadImage(ASSETS.background); }catch(e){}
  try{ img.avatar = await loadImage(ASSETS.avatar); }catch(e){}
  try{ img.hand = await loadImage(ASSETS.hand); }catch(e){}
  try{ img.candy = await loadImage(ASSETS.candy); }catch(e){}

  audio.click.src = ASSETS.sfxClick;
  audio.catch.src = ASSETS.sfxCatch;
}

/* ========= 相機 ========= */
let camera;
async function initCamera(){
  camera = new Camera(videoEl, {
    onFrame: async () => { await hands.send({image: videoEl}); },
    width: GAME_W,
    height: GAME_H
  });
  await camera.start();
}

/* ========= Audio & Camera Unlock ========= */
function unlockOnce(){
  if (audioUnlocked) return;
  audioUnlocked = true;
  document.getElementById("tip").style.display="none";
  startMusicFor(state);
}
document.addEventListener("pointerdown", unlockOnce, {once:true});
document.addEventListener("keydown", unlockOnce, {once:true});

/* ========= Main Loop ========= */
function loop(){
  requestAnimationFrame(loop);
  switch(state){
    case STATE_MENU: drawMenu(); break;
    case STATE_GAME: drawGame(); break;
    case STATE_OVER: drawOver(); break;
  }
}

/* ========= 啟動 ========= */
(async function main(){
  await loadAssets();
  await initCamera();
  startMusicFor(state);   // 主畫面 BGM
  loop();
})();
</script>
</body>
</html>
